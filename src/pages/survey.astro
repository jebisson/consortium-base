---
import SiteLayout from "../layouts/SiteLayout.astro";
import "../styles/global.css";
import logo from "../assets/consortium.png";
import survey from "../data/survey.json";
import { theme } from "../config/theme.js";

const { background, text, accent, border, bandBackground, glowColor } = theme.colors;
---

<SiteLayout title="Questionnaire TI – EÉSAD">

  <div style={`--bg: ${background}; --text: ${text}; --accent: ${accent}; --border: ${border}; --band: ${bandBackground}; `}>
  
    <style>
      /* Surfaces noires (comme index) */
      .card-surface { background: rgb(18,18,18); border: 1px solid rgba(0,0,0,0.16); box-shadow: 0 14px 40px rgba(0,0,0,0.18); }
      .card-icon { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); }
      .hover-tint { background: radial-gradient(circle at 18% 18%, color-mix(in srgb, var(--accent) 16%, transparent), transparent 62%); }
      .muted-on-dark { color: color-mix(in srgb, white 70%, transparent); }
      .soft-on-dark  { color: color-mix(in srgb, white 82%, transparent); }
      .band-title { color: rgba(17,17,17,0.92); }
      .band-soft  { color: rgba(17,17,17,0.75); }
      .band-muted { color: rgba(17,17,17,0.62); }
      .focus-ring:focus { outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 30%, transparent); }
    </style>
<!-- HEADER (same structure as other pages, text from original survey) -->
  <div slot="header" class="relative mx-auto flex flex-col items-center gap-3 z-10">
    <img src={logo.src} alt="EÉSAD" class="h-36 w-auto" />
    <h1 class="text-sm tracking-[0.25em] text-[color-mix(in_srgb,var(--text)_55%,transparent)] uppercase">
      Questionnaire TI
    </h1>
  </div>

  <!-- HERO (from original survey) -->
  <section slot="hero" class="mx-auto max-w-4xl px-4 text-center relative z-10">
    <!-- Glow -->
    <div
      class="absolute left-1/2 top-10 -translate-x-1/2
             w-[70%] md:w-[60%] h-24
             bg-[color:var(--accent)]/25 blur-[70px] opacity-80"
    ></div>

    <h2 class="text-3xl md:text-4xl font-semibold tracking-tight text-[var(--text)]">
      Portrait de votre environnement informatique
    </h2>

    <p class="mt-3 text-base md:text-md text-[color-mix(in_srgb,var(--text)_90%,transparent)]">
      Remplissez ce questionnaire. Les réponses seront envoyées à l’équipe TI.
    </p>
  </section>

  <!-- BACK LINK -->
  <a
    href="/"
    class="fixed right-6 top-5 z-50
           inline-flex items-center px-4 py-2 rounded-lg
           card-surface border border-[color-mix(in_srgb,var(--border)_65%,transparent)] 
           text-[color-mix(in_srgb,var(--text)_90%,transparent)] text-sm font-medium
           hover:opacity-90 hover:border-[color:var(--accent)] hover:text-[color:var(--text)]
           shadow-lg backdrop-blur
           transition-all"
  >
    ← Retour à la page Services TI
  </a>

  <!-- MAIN FORM SECTION WITH WAVE (same content as original, adapted to layout) -->
  <main class="mt-1">
    <section
      class="relative w-full overflow-hidden mt-10"
      style="background: var(--band);"
    >
      <!-- LIGNE OR + FADE (comme index) -->
      <div class="h-[2px] w-full" style="background: var(--accent);"></div>
      <div class="h-14 w-full" style="background: linear-gradient(to bottom, color-mix(in srgb, var(--accent) 18%, transparent), transparent);"></div>

      <!-- Lighting under the wave 
      <div
        class="absolute top-24 left-0 right-0 mx-auto w-[90%] h-40 blur-3xl z-0"
        style={`background-color: ${glowColor};`}
      ></div>
-->

      <!-- WAVE -->
      <!-- FORM TITLE -->
      <h3
        class="relative z-[3] text-center text-[color-mix(in_srgb,var(--text)_55%,transparent)]
               text-xs uppercase tracking-[0.25em] mt-10 mb-8"
      >
        Formulaire
      </h3>

      <!-- FORM BODY -->
      <div class="relative z-[3] mx-auto max-w-3xl px-4 pb-20">
        <form
          id="surveyForm"
          class="space-y-8 rounded-2xl p-8 card-surface border border-[color-mix(in_srgb,var(--border)_65%,transparent)] shadow-xl backdrop-blur-sm"
        >
          <!-- CLIENT INFO -->
          <section class="space-y-3 p-4 rounded-xl bg-[color-mix(in_srgb,var(--bg)_82%,black_18%)] border border-[color-mix(in_srgb,var(--border)_65%,transparent)]">
            <h2 class="text-xs uppercase tracking-[0.2em] text-[color-mix(in_srgb,var(--text)_55%,transparent)]">
              Informations du membre
            </h2>

            <label class="block text-base font-semibold">
              Nom <span class="text-rose-400">*</span>
            </label>
            <input
              name="client_nom"
              required
              class="w-full rounded-xl border border-[color-mix(in_srgb,var(--border)_65%,transparent)] bg-[color-mix(in_srgb,var(--bg)_82%,black_18%)]/80 px-3 py-2 focus-ring"
            />

            <label class="block text-base font-semibold">
              Courriel <span class="text-rose-400">*</span>
            </label>
            <input
              type="email"
              name="client_email"
              required
              class="w-full rounded-xl border border-[color-mix(in_srgb,var(--border)_65%,transparent)] bg-[color-mix(in_srgb,var(--bg)_82%,black_18%)]/80 px-3 py-2 focus-ring"
            />

            <label class="block text-base font-semibold">
              Organisation <span class="text-rose-400">*</span>
            </label>
            <input
              name="client_org"
              required
              class="w-full rounded-xl border border-[color-mix(in_srgb,var(--border)_65%,transparent)] bg-[color-mix(in_srgb,var(--bg)_82%,black_18%)]/80 px-3 py-2 focus-ring"
            />

            <label class="block text-base font-semibold">
              Téléphone (optionnel)
            </label>
            <input
              name="client_phone"
              class="w-full rounded-xl border border-[color-mix(in_srgb,var(--border)_65%,transparent)] bg-[color-mix(in_srgb,var(--bg)_82%,black_18%)]/80 px-3 py-2 focus-ring"
            />
          </section>

          <!-- DYNAMIC QUESTIONS (slider) -->
          {survey.map((q) => (
            <section class="space-y-4" data-id={q.id}>
              <label class="block text-base font-semibold">
                {q.question} {q.required && <span class="text-rose-400">*</span>}
              </label>

              <!-- Dynamic label for slider value (fix for updateSlider) -->
              <div
                id={q.id + "_label"}
                class="inline-flex items-center px-2 py-1 mb-1 text-xs rounded-full
                       bg-[rgba(0,0,0,0.25)] text-[var(--accent)] border border-[color-mix(in_srgb,var(--border)_65%,transparent)]"
              >
                Partiellement
              </div>

              <!-- SLIDER BLOCK -->
              <div class="w-full relative select-none">
                <!-- SLIDER INPUT -->
                <input
                  type="range"
                  name={q.id}
                  min="1"
                  max="4"
                  step="1"
                  value="2"
                  required={q.required}
                  class="w-full appearance-none bg-transparent cursor-pointer"
                  onInput={`updateSlider('${q.id}', this.value)`}
                />

                <!-- CUSTOM TRACK -->
                <div class="relative -mt-2">
                  <div class="h-2 bg-[rgba(255,255,255,0.08)] rounded-full"></div>

                  <!-- TICKS -->
                  <div
                    class="absolute top-1/2 left-0 w-full flex justify-between -translate-y-1/2"
                  >
                    <span class="w-2 h-2 rounded-full bg-[rgba(255,255,255,0.22)]"></span>
                    <span class="w-2 h-2 rounded-full bg-[rgba(255,255,255,0.22)]"></span>
                    <span class="w-2 h-2 rounded-full bg-[rgba(255,255,255,0.22)]"></span>
                    <span class="w-2 h-2 rounded-full bg-[rgba(255,255,255,0.22)]"></span>
                  </div>
                </div>

                <!-- LABELS -->
                <div class="flex justify-between mt-2 text-xs text-[color-mix(in_srgb,var(--text)_55%,transparent)]">
                  <span>Oui</span>
                  <span>Partiellement</span>
                  <span>Je ne sais pas</span>
                  <span>Non</span>
                </div>
              </div>
            </section>
          ))}

          <!-- SUBMIT -->
          <div class="flex items-center gap-3 pt-4">
            <button
              type="submit"
              class="rounded-xl px-4 py-2 font-semibold transition focus-ring" style="background: var(--accent); color: #111;"
            >
              Envoyer
            </button>
            <p id="status" class="text-sm text-[color-mix(in_srgb,var(--text)_55%,transparent)]"></p>
          </div>
        </form>

        <!-- RESULTS BOX (unchanged) -->
        <div
          id="resultsBox"
          class="hidden mt-6 p-6 rounded-2xl card-surface shadow-xl"
        >
          <h3 class="text-lg font-semibold text-[var(--text)] mb-2">Résultats</h3>
          <p class="text-[color-mix(in_srgb,var(--text)_78%,transparent)] text-sm">
            <b>Score total :</b> <span id="score_total"></span>
          </p>
          <p class="text-[color-mix(in_srgb,var(--text)_78%,transparent)] text-sm">
            <b>Maturité :</b> <span id="score_percent"></span>
          </p>
          <p class="mt-2 text-[color-mix(in_srgb,var(--text)_90%,transparent)]" id="score_message"></p>
        </div>
      </div>
    </section>
  </main>
  </div>
</SiteLayout>

<!-- SCRIPT (same logic as original, with slider label now present) -->
<script>
  const mapText = {
    1: "Oui",
    2: "Partiellement",
    3: "Je ne sais pas",
    4: "Non",
  };

  const mapScore = {
    1: 5,
    2: 3,
    3: 1,
    4: 2,
  };

  function updateSlider(id, value) {
    const el = document.getElementById(id + "_label");
    if (el) {
      el.textContent = mapText[value];
    }
  }

  const form = document.getElementById("surveyForm");
  const status = document.getElementById("status");

  const box = document.getElementById("resultsBox");
  const scoreTotal = document.getElementById("score_total");
  const scorePercent = document.getElementById("score_percent");
  const scoreMsg = document.getElementById("score_message");

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (status) status.textContent = "Envoi…";

      const fd = new FormData(form);
      const data = {};
      let totalScore = 0;
      let maxScore = 0;

      for (const [k, v] of fd.entries()) {
        if (k.startsWith("client_")) {
          data[k] = v;
          continue;
        }

        const num = Number(v);
        const score = mapScore[num] ?? 0;
        totalScore += score;
        maxScore += 5;
        data[k] = mapText[num] + " (" + score + ")";
      }

      const percent = Math.round((totalScore / maxScore) * 100);

      let msg = "";
      if (percent >= 85)
        msg = "Excellent — votre organisation démontre une très bonne posture de cybersécurité.";
      else if (percent >= 70)
        msg = "Bon — quelques améliorations sont recommandées.";
      else if (percent >= 50)
        msg = "Moyen — plusieurs contrôles doivent être renforcés.";
      else msg = "Faible — un plan d’action TI prioritaire est recommandé.";

      if (scoreTotal) scoreTotal.textContent = `${totalScore} / ${maxScore}`;
      if (scorePercent) scorePercent.textContent = `${percent}%`;
      if (scoreMsg) scoreMsg.textContent = msg;
      if (box) box.classList.remove("hidden");

      data["score_total"] = `${totalScore} / ${maxScore}`;
      data["score_percent"] = percent + "%";
      data["score_message"] = msg;

      try {
        const res = await fetch("/api/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (status)
          status.textContent = res.ok
            ? "Merci! Vos réponses ont été envoyées."
            : "Erreur d’envoi.";
      } catch {
        if (status) status.textContent = "Erreur réseau.";
      }
    });
  }
</script>

<!-- CUSTOM THUMB (same as original) -->
<style>
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 0.75rem;
    background: transparent;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    background: rgb(56 189 248);
    border-radius: 9999px;
    cursor: pointer;
    margin-top: -8px;
  }
  input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    background: rgb(56 189 248);
    border-radius: 9999px;
    cursor: pointer;
  }
</style>
