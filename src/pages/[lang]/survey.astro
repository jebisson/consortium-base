---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { t } from "../../i18n/utils";
import { tenant } from "../../config/tenant";
import surveyData from "../../data/survey.json";

export const prerender = true;
export function getStaticPaths() {
  return [{ params: { lang: "fr" } }, { params: { lang: "en" } }];
}

const { lang } = Astro.params as { lang: string };
const tr = t(lang);
const sv = tr.survey;
const common = tr.common;
const currentPath = `/${lang}/survey`;

const labels = sv.sliderLabels; // [{text, score}, …]
const defaultIdx = 0;           // slider starts at position 1 (index 0 = "Oui/Yes")
---

<SiteLayout title={sv.title} lang={lang} currentPath={currentPath}>
  <style>
    .card-dark {
      background: var(--card);
      border: 1px solid color-mix(in srgb, white 7%, transparent);
      box-shadow: 0 14px 40px rgba(0,0,0,0.28);
      border-radius: 1rem;
    }
    .focus-ring:focus {
      outline: none;
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 30%, transparent);
    }

    /* ── Slider track ── */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 0;
      background: transparent;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      background: var(--accent);
      border-radius: 9999px;
      cursor: grab;
      margin-top: -9px;
      box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 50%, transparent);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    input[type="range"]:active::-webkit-slider-thumb {
      cursor: grabbing;
      transform: scale(1.15);
      box-shadow: 0 0 18px color-mix(in srgb, var(--accent) 70%, transparent);
    }
    input[type="range"]::-moz-range-thumb {
      width: 22px;
      height: 22px;
      background: var(--accent);
      border-radius: 9999px;
      cursor: grab;
      border: none;
      box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 50%, transparent);
    }

    /* ── Slider filled track ── */
    .slider-wrap { position: relative; padding-bottom: 1.5rem; }
    .slider-track-bg {
      position: absolute;
      top: 50%; left: 0; right: 0;
      height: 4px;
      background: rgba(255,255,255,0.10);
      border-radius: 999px;
      transform: translateY(-50%);
      z-index: 0;
    }
    .slider-fill {
      position: absolute;
      top: 50%; left: 0;
      height: 4px;
      background: var(--accent);
      border-radius: 999px;
      transform: translateY(-50%);
      pointer-events: none;
      z-index: 1;
      transition: width 0.1s;
    }

  </style>

  <!-- HEADER -->
  <div slot="header" class="flex flex-col items-center">
    <img src={tenant.logoSrc} alt={tenant.name} class="h-28 md:h-36 w-auto drop-shadow-lg" />
    <p class="mt-3 text-xs tracking-[0.35em] uppercase"
       style="color: color-mix(in srgb, var(--text) 55%, transparent);">
      {sv.heroTitle}
    </p>
  </div>

  <!-- HERO -->
  <section slot="hero" class="max-w-4xl mx-auto px-4 text-center relative z-10">
    <div class="absolute left-1/2 top-10 -translate-x-1/2 w-[60%] h-24 blur-[70px] opacity-70 pointer-events-none"
         style="background: color-mix(in srgb, var(--accent) 22%, transparent);"></div>
    <h1 class="text-3xl md:text-4xl font-bold tracking-tight animate-fade-up" style="color: var(--text);">
      {sv.heroTitle}
    </h1>
    <p class="mt-3 text-base md:text-lg animate-fade-up animate-fade-up-delay-1"
       style="color: color-mix(in srgb, var(--text) 85%, transparent);">
      {sv.heroDesc}
    </p>
  </section>

  <!-- MAIN -->
  <main class="mt-1">
    <section class="relative w-full overflow-hidden mt-10" style="background: var(--band);">
      <div class="h-[2px] w-full" style="background: var(--accent);"></div>
      <div class="h-12 w-full"
           style="background: linear-gradient(to bottom, color-mix(in srgb, var(--accent) 16%, transparent), transparent);"></div>

      <div class="relative z-10 mx-auto max-w-3xl px-4 pb-20 pt-6">

        <form id="surveyForm" class="space-y-3">
          <input type="hidden" name="form_type" value="survey" />

          <!-- Client info -->
          <div class="card-dark p-6 space-y-4 reveal">
            <p class="text-xs uppercase tracking-[0.25em]"
               style="color: color-mix(in srgb, var(--text) 50%, transparent);">
              {lang === "fr" ? "Informations" : "Contact info"}
            </p>

            <div class="grid sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1"
                       style="color: color-mix(in srgb, var(--text) 80%, transparent);">
                  {lang === "fr" ? "Nom" : "Name"} <span class="text-rose-400">*</span>
                </label>
                <input name="client_nom" required
                       class="focus-ring w-full rounded-lg px-3 py-2 text-sm"
                       style="background: rgba(0,0,0,0.30); border: 1px solid rgba(255,255,255,0.10); color: var(--text);" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1"
                       style="color: color-mix(in srgb, var(--text) 80%, transparent);">
                  {common.email} <span class="text-rose-400">*</span>
                </label>
                <input type="email" name="client_email" required
                       class="focus-ring w-full rounded-lg px-3 py-2 text-sm"
                       style="background: rgba(0,0,0,0.30); border: 1px solid rgba(255,255,255,0.10); color: var(--text);" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1"
                       style="color: color-mix(in srgb, var(--text) 80%, transparent);">
                  {common.orgName} <span class="text-rose-400">*</span>
                </label>
                <input name="client_org" required
                       class="focus-ring w-full rounded-lg px-3 py-2 text-sm"
                       style="background: rgba(0,0,0,0.30); border: 1px solid rgba(255,255,255,0.10); color: var(--text);" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1"
                       style="color: color-mix(in srgb, var(--text) 80%, transparent);">
                  {common.phone} {common.optional}
                </label>
                <input name="client_phone"
                       class="focus-ring w-full rounded-lg px-3 py-2 text-sm"
                       style="background: rgba(0,0,0,0.30); border: 1px solid rgba(255,255,255,0.10); color: var(--text);" />
              </div>
            </div>
          </div>

          <!-- Questions with sliders -->
          {surveyData.map((q, idx) => (
            <div class="card-dark p-5 reveal" data-question={q.id}>
              <div class="mb-4">
                <p class="text-sm md:text-base font-medium leading-snug"
                   style="color: color-mix(in srgb, var(--text) 92%, transparent);">
                  <span class="font-bold mr-1.5" style="color: var(--accent);">{idx + 1}.</span>
                  {q.question}
                </p>
              </div>

              <div class="slider-wrap mt-2">
                <div class="slider-track-bg"></div>
                <div class="slider-fill" id={`${q.id}_fill`} style="width: 0%;"></div>
                <input
                  type="range"
                  name={q.id}
                  min="1"
                  max={labels.length}
                  step="1"
                  value="1"
                  required={q.required}
                  data-qid={q.id}
                  class="w-full"
                />
                <!-- Step labels -->
                <div class="absolute bottom-0 left-0 right-0 flex justify-between text-xs"
                     style="color: color-mix(in srgb, var(--text) 50%, transparent);">
                  {labels.map((l) => <span>{l.text}</span>)}
                </div>
              </div>
            </div>
          ))}

          <!-- Submit -->
          <div class="pt-2">
            <button type="submit"
                    class="w-full inline-flex items-center justify-center px-8 py-4 rounded-xl font-semibold text-base transition hover:brightness-110 reveal"
                    style="background: var(--accent); color: #111; box-shadow: 0 10px 28px color-mix(in srgb, var(--accent) 30%, transparent);">
              {sv.submitBtn}
            </button>
            <p id="surveyStatus" class="text-sm text-center mt-3"
               style="color: color-mix(in srgb, var(--text) 60%, transparent);"></p>
          </div>
        </form>

        <!-- Result panel -->
        <div id="resultPanel" class="hidden mt-10 p-8 rounded-2xl card-dark text-center reveal">
          <h3 class="text-2xl font-bold mb-2" style="color: var(--accent);">{sv.resultTitle}</h3>
          <p class="mb-4" style="color: color-mix(in srgb, var(--text) 65%, transparent);">{sv.resultDesc}</p>
          <p class="text-5xl font-extrabold mb-4" style="color: var(--text);" id="scoreDisplay">—</p>
          <p id="scoreLabel" class="text-lg font-semibold"></p>
        </div>

      </div>
    </section>
  </main>

</SiteLayout>

<script define:vars={{
  sliderLabels:  sv.sliderLabels,
  msgSending:    common.sending,
  msgDone:       common.sent,
  msgError:      common.errorSend,
  msgNetwork:    common.errorNetwork,
  maxScore:      sv.maxScore,
  scoreLabels:   sv.scoreLabels,
}}>

  // ── Update badge + fill on slider move ──
  function updateSlider(input) {
    const idx  = parseInt(input.value, 10) - 1;
    const pct  = ((idx) / (sliderLabels.length - 1)) * 100;
    const fill = document.getElementById(input.dataset.qid + "_fill");
    if (fill) fill.style.width = pct + "%";
  }

  // Init all sliders at position 1
  document.querySelectorAll("input[type='range'][data-qid]").forEach((input) => {
    updateSlider(input);
    input.addEventListener("input", () => updateSlider(input));
  });

  // ── Form submit ──
  const form    = document.getElementById("surveyForm");
  const status  = document.getElementById("surveyStatus");
  const panel   = document.getElementById("resultPanel");
  const display = document.getElementById("scoreDisplay");
  const label   = document.getElementById("scoreLabel");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (status) status.textContent = msgSending;

    const fd   = new FormData(form);
    const data = {};
    let total  = 0;

    for (const [k, v] of fd.entries()) {
      if (k.startsWith("client_") || k === "form_type") {
        data[k] = v; continue;
      }
      const idx   = parseInt(v, 10) - 1;
      const entry = sliderLabels[idx];
      if (entry) { total += entry.score; }
      data[k] = entry ? `${entry.text} (${entry.score})` : v;
    }

    data["score_total"]   = `${total} / ${maxScore}`;
    const pct             = Math.round((total / maxScore) * 100);
    data["score_percent"] = pct + "%";

    const found = scoreLabels.find((l) => total >= l.min && total <= l.max);
    data["score_message"] = found ? found.label : "";

    // Show result immediately
    if (panel && display && label) {
      display.textContent = `${total} / ${maxScore}`;
      if (found) {
        label.textContent = found.label;
        label.className   = `text-lg font-semibold ${found.color}`;
      }
      panel.classList.remove("hidden");
      panel.scrollIntoView({ behavior: "smooth" });
    }

    // Send to API
    try {
      const res = await fetch("/api/submit", {
        method:  "POST",
        headers: { "Content-Type": "application/json" },
        body:    JSON.stringify(data),
      });
      if (status) status.textContent = res.ok ? msgDone : msgError;
    } catch {
      if (status) status.textContent = msgNetwork;
    }
  });
</script>
