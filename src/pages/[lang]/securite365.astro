---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { t } from "../../i18n/utils";
import { tenant } from "../../config/tenant";

export const prerender = true;
export function getStaticPaths() {
  return [{ params: { lang: "fr" } }, { params: { lang: "en" } }];
}

const { lang } = Astro.params as { lang: string };
const tr = t(lang);
const s = tr.security;
const common = tr.common;

const homeLink = `/${lang}`;
const currentPath = `/${lang}/securite365`;
---

<SiteLayout title={s.title} lang={lang} currentPath={currentPath}>

  <style>
    .card-dark {
      background: rgb(18,18,18);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 14px 40px rgba(0,0,0,0.22);
      border-radius: 1rem;
    }
    .hover-tint {
      background: radial-gradient(circle at 18% 18%, color-mix(in srgb, var(--accent) 16%, transparent), transparent 62%);
      position: absolute; inset: 0; pointer-events: none; opacity: 0.70;
      transition: opacity 0.3s;
    }
    .soft { color: color-mix(in srgb, white 82%, transparent); }
    .muted { color: color-mix(in srgb, white 68%, transparent); }
    .icon-accent { color: var(--accent); }
    .card-icon {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 30%, transparent); }
  </style>

  <!-- HEADER -->
  <div slot="header" class="flex flex-col items-center">
    <img src={tenant.logoSrc} alt={tenant.name} class="h-28 md:h-36 w-auto drop-shadow-lg" />
    <p class="mt-3 text-xs tracking-[0.35em] uppercase"
       style="color: color-mix(in srgb, var(--text) 55%, transparent);">Services TI</p>
  </div>

  <!-- HERO -->
  <div slot="hero" class="relative max-w-4xl mx-auto px-4 text-center z-20 pt-2 pb-10">
    <div class="pointer-events-none absolute left-1/2 top-8 -translate-x-1/2 w-[65%] h-24 blur-[80px] opacity-60"
         style="background: color-mix(in srgb, var(--accent) 20%, transparent);"></div>

    <h1 class="mt-4 text-4xl md:text-5xl font-bold tracking-tight animate-fade-up" style="color: var(--text);">
      {s.heroTitle}
    </h1>
    <h2 class="mt-3 text-lg md:text-xl font-semibold soft animate-fade-up animate-fade-up-delay-1">
      {s.heroSubtitle}
    </h2>
    <p class="mt-3 text-sm muted animate-fade-up animate-fade-up-delay-2">{s.hoverHint}</p>
  </div>
  <!-- BACK LINK -->

  <!-- BAND -->
  <section class="relative w-full overflow-hidden" style="background: var(--band);">
    <div class="h-[2px] w-full" style="background: var(--accent);"></div>
    <div class="h-12 w-full"
         style="background: linear-gradient(to bottom, color-mix(in srgb, var(--accent) 16%, transparent), transparent);"></div>

    <div class="relative mx-auto max-w-5xl px-4 pt-6 pb-6">
      <div class="grid md:grid-cols-2 gap-6">

        <!-- Audit card -->
        <section class="group relative overflow-hidden rounded-2xl p-8 card-dark reveal">
          <div class="hover-tint"></div>
          <div class="relative">
            <div class="h-11 w-11 rounded-xl card-icon flex items-center justify-center mb-4">
              <svg class="h-6 w-6 icon-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
              </svg>
            </div>
            <p class="text-xs uppercase tracking-[0.25em] muted">{s.auditLabel}</p>
            <h3 class="mt-2 text-2xl font-semibold" style="color: white;">{s.auditTitle}</h3>
            <p class="mt-3 leading-relaxed soft">{s.auditDesc}</p>
            <div class="mt-6">
              <button id="openAuditBtn"
                      class="px-6 py-3 rounded-xl font-semibold transition hover:brightness-110"
                      style={`background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 92%, white 8%), color-mix(in srgb, var(--accent) 72%, black 28%)); color: #111;`}>
                {s.auditBtn}
              </button>
            </div>
            <ul class="mt-6 list-disc ml-6 space-y-2 text-sm soft">
              {s.auditBullets.map((b) => <li>{b}</li>)}
            </ul>
          </div>
        </section>

        <!-- Contact card -->
        <section class="group relative overflow-hidden rounded-2xl p-8 card-dark reveal">
          <div class="hover-tint"></div>
          <div class="relative">
            <div class="h-11 w-11 rounded-xl card-icon flex items-center justify-center mb-4">
              <svg class="h-6 w-6 icon-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.81 19.79 19.79 0 01.01 1.18 2 2 0 012 0h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.09 7.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 14.92z"/>
              </svg>
            </div>
            <p class="text-xs uppercase tracking-[0.25em] muted">{s.contactLabel}</p>
            <h3 class="mt-2 text-2xl font-semibold" style="color: white;">{s.contactTitle}</h3>
            <p class="mt-3 leading-relaxed soft">{s.contactDesc}</p>
            <button id="openContactBtn"
                    class="inline-flex mt-6 px-6 py-3 rounded-xl font-semibold transition hover:brightness-110"
                    style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); color: rgba(255,255,255,0.92);">
              {s.contactBtn}
            </button>

            <div id="contactFormContainer" class="overflow-hidden max-h-0 opacity-0 transition-all duration-500 mt-6">
              <form id="contactForm" class="space-y-4 p-6 rounded-xl"
                    style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10);">
                <h4 class="text-xl font-semibold mb-2" style="color: white;">{s.formTitle}</h4>

                <label class="block text-sm font-medium" style="color: rgba(255,255,255,0.92);">{common.orgName}</label>
                <input type="text" name="contact_org" required class="focus-ring w-full rounded-lg px-3 py-2"
                       style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.10); color: white;" />

                <label class="block text-sm font-medium" style="color: rgba(255,255,255,0.92);">{common.email}</label>
                <input type="email" name="contact_email" required class="focus-ring w-full rounded-lg px-3 py-2"
                       style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.10); color: white;" />

                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium" style="color: rgba(255,255,255,0.92);">{common.phone} {common.optional}</label>
                    <input type="text" name="contact_phone" class="focus-ring w-full rounded-lg px-3 py-2"
                           style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.10); color: white;" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium" style="color: rgba(255,255,255,0.92);">{common.usersOpt}</label>
                    <input type="number" name="contact_users" min="1" class="focus-ring w-full rounded-lg px-3 py-2"
                           style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.10); color: white;" />
                  </div>
                </div>

                <label class="block text-sm font-medium" style="color: rgba(255,255,255,0.92);">{common.subject}</label>
                <select name="contact_subject" class="focus-ring w-full rounded-lg px-3 py-2"
                        style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.10); color: white;">
                  {s.subjectOptions.map((opt) => (
                    <option value={opt.value}>{opt.label}</option>
                  ))}
                </select>

                <label class="block text-sm font-medium" style="color: rgba(255,255,255,0.92);">{common.message}</label>
                <textarea name="contact_message" rows="5" required class="focus-ring w-full rounded-lg px-3 py-2"
                          style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.10); color: white;"
                          placeholder={s.msgPlaceholder}></textarea>

                <input type="hidden" name="contact_source" value="securite365" />

                <button type="submit" class="mt-2 w-full px-4 py-2 rounded-lg font-semibold transition hover:brightness-110"
                        style="background: var(--accent); color: #111;">{common.sendRequest}</button>
                <button type="button" id="closeContactBtn" class="w-full px-4 py-2 rounded-lg font-medium transition hover:brightness-110"
                        style="background: rgba(255,255,255,0.06); color: white; border: 1px solid rgba(255,255,255,0.10);">{common.close}</button>
                <p id="contactStatus" class="text-sm mt-2 soft"></p>
              </form>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- 14 security points -->
    <div class="relative mx-auto max-w-5xl px-4 pt-8 pb-24 grid gap-6">
      {s.points.map((p, i) => (
        <section class="group relative overflow-hidden rounded-2xl p-6 card-dark transition-all duration-300 hover:-translate-y-1 reveal">
          <div class="hover-tint"></div>
          <div class="relative flex items-start gap-5">
            <div class="shrink-0">
              <div class="grid place-items-center w-14 h-14 rounded-full"
                   style={`background: rgba(0,0,0,0.25); border: 2px solid color-mix(in srgb, var(--accent) 35%, transparent); box-shadow: 0 0 18px color-mix(in srgb, var(--accent) 18%, transparent);`}>
                <span class="text-2xl font-extrabold" style="color: var(--accent);">{i + 1}</span>
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-lg md:text-xl font-semibold" style="color: white;">{p.t}</h3>
              <div class="mt-3 space-y-3 opacity-0 max-h-0 overflow-hidden transition-all duration-300 group-hover:opacity-100 group-hover:max-h-[900px]">
                {p.lead.map((para) => (
                  <p class="text-[15px] leading-relaxed soft">{para}</p>
                ))}
              </div>
            </div>
          </div>
        </section>
      ))}
    </div>
  </section>

</SiteLayout>

<script define:vars={{ msgSending: tr.common.sending, msgDone: tr.common.sentShort, msgError: tr.common.errorSend, msgNetwork: tr.common.errorNetwork }}>
  const openAuditBtn = document.getElementById("openAuditBtn");
  const openContactBtn = document.getElementById("openContactBtn");
  const closeContactBtn = document.getElementById("closeContactBtn");
  const panel = document.getElementById("contactFormContainer");
  const form = document.getElementById("contactForm");
  const status = document.getElementById("contactStatus");

  function openPanel(prefillSubject) {
    if (!panel) return;
    const subject = form?.querySelector('select[name="contact_subject"]');
    if (subject && prefillSubject) subject.value = prefillSubject;
    panel.style.maxHeight = panel.scrollHeight + "px";
    panel.style.opacity = "1";
    panel.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  if (openAuditBtn) openAuditBtn.addEventListener("click", () => openPanel("Audit 365 - 99$"));
  if (openContactBtn) openContactBtn.addEventListener("click", () => openPanel());
  if (closeContactBtn && panel) {
    closeContactBtn.addEventListener("click", () => {
      panel.style.maxHeight = "0";
      panel.style.opacity = "0";
    });
  }
  if (form && status) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const data = {};
      for (const [k, v] of fd.entries()) data[k] = v;
      status.textContent = msgSending;
      try {
        const res = await fetch("/api/submit", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) });
        status.textContent = res.ok ? msgDone : msgError;
        if (res.ok) form.reset();
      } catch { status.textContent = msgNetwork; }
    });
  }
</script>
